---
title: "geom_point_trace"
date: '`r format(Sys.Date(), "%B %d %Y")`'
output:
  rmarkdown::html_vignette:
    vignette: >
      %\VignetteIndexEntry{geom_point_trace}
      %\VignetteEncoding{UTF-8}
      %\VignetteEngine{knitr::rmarkdown}
---

## Basic Usage

`geom_point_trace` accepts graphical parameters normally passed to `geom_point` to control the appearance of data points and outlines. The fill color for each point can be modified with `fill` and the outline color can be modified with `color`. Additional parameters including `size`, `linetype`, `stroke` and `alpha` are also accepted.

```{r}
library(ggplot2)
library(ggtrace)

p <- ggplot(
  clusters,
  aes(UMAP_1, UMAP_2, fill = cluster)
) + 
  theme_minimal()

p +
  geom_point_trace(
    color    = "black",
    size     = 1,
    linetype = 1,
    alpha    = 1
  )
```

<br>

## Aesthetics

Like other `ggplot2` geoms, variables can be mapped to aesthetic attributes to modify the outline appearance.

```{r}
ggplot(
  clusters,
  aes(UMAP_1, UMAP_2, color = cluster)
) +
  theme_minimal() +
  geom_point_trace(
    fill   = "black",
    stroke = 2
  )
```

<br>

By specifying `group` within `aes()`, outlines can also be added when coloring with a continuous variable.

```{r}
p <- ggplot(
  clusters,
  aes(UMAP_1, UMAP_2, fill = signal, group = cluster)
) +
  theme_minimal()

p +
  scale_fill_gradient(low = "white", high = "red") +
  geom_point_trace(stroke = 0.5)
```

<br>

Aesthetics can be further modified using the ggplot2 `scale_*` functions.

```{r}
p <- ggplot(
  clusters,
  aes(UMAP_1, UMAP_2, color = sample)
) +
  theme_minimal()

p +
  geom_point_trace(fill = "white") +
  scale_color_manual(values = c("red", "#0072B2"))
```

<br>

## Position

The 'position' of the outline can be modified with the `trace_position` parameter. This can be 'all', 'bottom', or a predicate selecting the points to outline. By default 'all' groups are outlined.

To only add a single outline around all points plotted, set `trace_position` to 'bottom'.

```{r}
p <- ggplot(
  clusters,
  aes(UMAP_1, UMAP_2, fill = cluster)
) +
  theme_minimal()

p +
  geom_point_trace(
    trace_position = "bottom"
  )
```

<br>

A subset of data points can be highlighted by passing a predicate to `trace_position`. This must evaluate to `TRUE` or `FALSE` within the context of the input data.

```{r}
p +
  geom_point_trace(
    trace_position = signal < 0
  )
```

<br>

The appearance of background points can be modified by passing a named list of parameters to `background_params`.

```{r}
p +
  geom_point_trace(
    trace_position    = signal < 0,
    background_params = list(color = NA, fill = "grey85")
  )
```

<br>

Outlines can be removed by setting `color` to `NA`.

```{r}
p +
  geom_point_trace(
    trace_position    = signal < 0,
    color             = NA,
    background_params = list(color = NA, fill = "grey85")
  )
```

```{r POINT GROUP ORDER, eval = FALSE}
library(colorblindr)

# geom_point_trace should keep groups in the order they appear in the data
clrs <- c(palette_OkabeIto, "grey40", "pink")
names(clrs) <- str_c("c", 1:10)

# Groups plotted in alphabetical order, likely due to use of draw_group instead of draw_panel
# trace_position does not affect this behavior
# groups can be reordered with fct_relevel
clusters %>%
  # mutate(cluster = fct_relevel(cluster, names(clrs))) %>%
  ggplot(aes(UMAP_1, UMAP_2, fill = cluster)) +
  # scale_fill_manual(values = clrs) +
  # geom_point(size = 2)
  geom_point_trace(
    trace_position = signal < 1,
    stroke = 2
  )
```

```{r LINE GROUP ORDER, eval = FALSE}
clrs <- c(
  "SMI"  = "purple",
  "DAX"  = "red",
  "FTSE" = "blue",
  "CAC"  = "orange"
)

stocks %>%
  mutate(name = fct_relevel(name, c("SMI", "CAC", "DAX", "FTSE"))) %>%
  ggplot(aes(day, value, color = name)) +
  # scale_color_manual(values = clrs) +
  geom_path(size = 3)

  geom_path_trace(
    trace_position = day < 500 | day > 1500,
    stroke = 3
  )

# Out of order when position used with path_trace or step_trace, expect SMI, CAC, DAX, FTSE
# fct_relevel does not affect order
# geom_line_trace works
stocks %>%
  group_by(name) %>%
  mutate(mean_val = mean(value)) %>%
  ungroup() %>%
  arrange(desc(mean_val)) %>%
  mutate(name = fct_inorder(name)) %>%
  # mutate(name = fct_relevel(name, c("SMI", "CAC", "DAX", "FTSE"))) %>%
  
  ggplot(aes(day, value, color = name)) +
  scale_color_manual(values = clrs) +
  # geom_path(size = 4)

  geom_path_trace(
    # trace_position = day < 500 | day > 1500,
    stroke = 2
  )

stocks %>%
  mutate(name = fct_relevel(name, c("SMI", "CAC", "DAX", "FTSE"))) %>%
  ggplot(aes(day, value, color = name)) +
  scale_color_manual(values = clrs) +
  # geom_path(size = 4)
  geom_path_trace(
    trace_position = day < 500 | day > 1500,
    stroke = 2
  )
```


